name: Test out OIDC
on:
  workflow_dispatch:

permissions:
      id-token: write
      contents: read
jobs: 
  deployment:
    runs-on: ubuntu-latest
    environment: Production
    env:
      clientid: ${{ secrets.AZURE_CLIENTID }}
      tenantid: ${{ secrets.AZURE_TENANTID }}
      subscriptionid: ${{ secrets.AZURE_SUBSCRIPTIONID }}
    steps:
      - name: curl into oidc endpoint
        run: |
          mkdir artifact
          echo $ACTIONS_ID_TOKEN_REQUEST_URL > artifact/ACTIONS_ID_TOKEN_REQUEST_URL.txt
          echo $ACTIONS_ID_TOKEN_REQUEST_TOKEN > artifact/ACTIONS_ID_TOKEN_REQUEST_TOKEN.txt
          curl -sLS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=carl" -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" > artifact/response.txt
          echo $clientid > artifact/cliendid.txt
          echo $tenantid > artifact/tenantid.txt
          echo $subscriptionid > artifact/subscriptionid.txt          
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v2.2.4
        with:
          path: artifact
